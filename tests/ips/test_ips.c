/**
 * Copyright 2022 TotalJustice.
 * SPDX-License-Identifier: Zlib
 */

#include <stddef.h>
#include <stdint.h>
#include <stdbool.h>
#include <test_framework.h>


// simple test data
static bool test_1(void)
{
    const uint8_t src_data[] = {0x31, 0x32, 0x33, 0x34, 0x35};
    const uint8_t expected_data[] = {0x35, 0x34, 0x33, 0x32, 0x31};
    const uint8_t patch_data[] = {
        0x50, 0x41, 0x54, 0x43, 0x48, 0x00, 0x00, 0x00, 0x00, 0x05, 0x35, 0x34,
        0x33, 0x32, 0x31, 0x45, 0x4f, 0x46
    };
    return patch_runner(PatchType_IPS, expected_data, sizeof(expected_data), src_data, sizeof(src_data), patch_data, sizeof(patch_data));
}

// tests that it rejects invalid patch
static bool test_2(void)
{
    const uint8_t src_data[] = {0x31, 0x32, 0x33, 0x34, 0x35};
    const uint8_t expected_data[] = {0x35, 0x34, 0x33, 0x32, 0x31};
    const uint8_t patch_data[] = {
        0x51, 0x41, 0x54, 0x43, 0x48, 0x00, 0x00, 0x00, 0x00, 0x05, 0x35, 0x34,
        0x33, 0x32, 0x31, 0x45, 0x4f, 0x46
    };
    return !patch_runner(PatchType_IPS, expected_data, sizeof(expected_data), src_data, sizeof(src_data), patch_data, sizeof(patch_data));
}

// tests that it rejects invalid src
// static bool test_3(void)
// {
//     const uint8_t src_data[] = {0x31, 0x32, 0x33, 0x34, 0x36};
//     const uint8_t expected_data[] = {0x35, 0x34, 0x33, 0x32, 0x31};
//     const uint8_t patch_data[] = {
//         0x50, 0x41, 0x54, 0x43, 0x48, 0x00, 0x00, 0x00, 0x00, 0x05, 0x35, 0x34,
//         0x33, 0x32, 0x31, 0x45, 0x4f, 0x46
//     };
//     return !patch_runner(PatchType_IPS, expected_data, sizeof(expected_data), src_data, sizeof(src_data), patch_data, sizeof(patch_data));
// }

// tests the growth of data
static bool test_4(void)
{
    const uint8_t src_data[] = {0x31, 0x32, 0x33, 0x34, 0x35};
    const uint8_t expected_data[] = {0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39};
    const uint8_t patch_data[] = {
        0x50, 0x41, 0x54, 0x43, 0x48, 0x00, 0x00, 0x05, 0x00, 0x04, 0x36, 0x37,
        0x38, 0x39, 0x45, 0x4f, 0x46
    };
    return patch_runner(PatchType_IPS, expected_data, sizeof(expected_data), src_data, sizeof(src_data), patch_data, sizeof(patch_data));
}

// tests shrinking of data
static bool test_5(void)
{
    const uint8_t src_data[] = {0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39};
    const uint8_t expected_data[] = {0x73, 0x6d, 0x6f, 0x6c};
    const uint8_t patch_data[] = {
        0x50, 0x41, 0x54, 0x43, 0x48, 0x00, 0x00, 0x00, 0x00, 0x04, 0x73, 0x6d,
        0x6f, 0x6c, 0x45, 0x4f, 0x46, 0x00, 0x00, 0x04
    };
    return patch_runner(PatchType_IPS, expected_data, sizeof(expected_data), src_data, sizeof(src_data), patch_data, sizeof(patch_data));
}

// tests the growth of data (hard)
static bool test_6(void)
{
    const uint8_t src_data[] = {0x31, 0x32, 0x33, 0x34, 0x35};
    const uint8_t expected_data[] = {
        0x69, 0x20, 0x61, 0x6d, 0x20, 0x62, 0x69, 0x67, 0x20, 0x64, 0x61, 0x74,
        0x61, 0x20, 0x31, 0x32, 0x33, 0x34, 0x35, 0x20, 0x73, 0x74, 0x69, 0x6c,
        0x6c, 0x20, 0x67, 0x6f, 0x69, 0x6e, 0x67, 0x2e, 0x2e, 0x2e
    };
    const uint8_t patch_data[] = {
        0x50, 0x41, 0x54, 0x43, 0x48, 0x00, 0x00, 0x00, 0x00, 0x22, 0x69, 0x20,
        0x61, 0x6d, 0x20, 0x62, 0x69, 0x67, 0x20, 0x64, 0x61, 0x74, 0x61, 0x20,
        0x31, 0x32, 0x33, 0x34, 0x35, 0x20, 0x73, 0x74, 0x69, 0x6c, 0x6c, 0x20,
        0x67, 0x6f, 0x69, 0x6e, 0x67, 0x2e, 0x2e, 0x2e, 0x45, 0x4f, 0x46
    };
    return patch_runner(PatchType_IPS, expected_data, sizeof(expected_data), src_data, sizeof(src_data), patch_data, sizeof(patch_data));
}

int main(void)
{
    if (!test_1()) { return 1; }
    if (!test_2()) { return 2; }
    // if (!test_3()) { return 3; } // this is impossible to pass sadly
    if (!test_4()) { return 4; }
    if (!test_5()) { return 5; }
    if (!test_6()) { return 6; }

    return 0;
}
